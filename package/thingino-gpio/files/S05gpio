#!/bin/sh

. /usr/share/common

GPIO_FILE="/etc/gpio.conf"
[ -f "$GPIO_FILE" ] || die "GPIO configuration file not found: $GPIO_FILE"

VALID_STATES="high low input"

# TODO: Set the maximum GPIO number by SOC model
MAX_GPIO=192

start() {
	echo " Setting GPIOs" >&2

	while IFS= read -r line; do
		# Skip empty lines and comments
		[ -z "$line" ] || echo "$line" | grep -q '^#' && continue

		# Extract fields and validate
		set -- $line
		gpionum=$1
		state=$(echo "$2" | tr A-Z a-z)
		case "$VALID_STATES" in
			*"$state"*)
				# pin is in valid range
				if [ "$gpionum" -lt 0 ] || [ "$gpionum" -gt $MAX_GPIO ]; then
					echo "Invalid GPIO number: $gpionum in line: $line" >&2
				else
					gpio "$state" "$gpionum"
					echo "GPIO $gpionum set to $state" >&2

					if [ -n "$3" ]; then
						echo "Description: $3" >&2
					fi
				fi
				;;
			*)
				echo "Invalid state: $state in line: $line"
				;;
		esac
	done < $GPIO_FILE
}

case "$1" in
	start)
		start
		;;
	stop)
		true
		;;
	restart)
		start
		;;
	*)
		echo "Usage: $0 {start|stop|restart}"
		exit 1
		;;
esac

exit 0
